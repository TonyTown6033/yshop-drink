# 🔄 完整工作流程

## 📋 从开发到生产的完整流程

```
┌─────────────────────────────────────────────────────────────┐
│                    1. 本地开发                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 修改代码                                         │   │
│  │  - 本地测试                                         │   │
│  │  - git commit & push                                │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                    2. 创建 Release                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  git tag v1.0.0 -m "Release message"                │   │
│  │  git push origin v1.0.0                             │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│              3. GitHub Actions 自动构建                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ✓ Checkout 代码                        (5秒)      │   │
│  │  ✓ 设置 JDK 17                          (10秒)     │   │
│  │  ✓ 缓存 Maven 依赖                      (15秒)     │   │
│  │  ✓ 设置 Node.js 18                      (5秒)      │   │
│  │  ✓ 安装 pnpm                            (3秒)      │   │
│  │  ✓ 缓存 pnpm 依赖                       (10秒)     │   │
│  │  ✓ 构建后端（Maven）                    (4分钟)    │   │
│  │  ✓ 构建前端（Vue3）                     (2分钟)    │   │
│  │  ✓ 打包部署文件                         (15秒)     │   │
│  │  ✓ 创建 Release                         (10秒)     │   │
│  │  ✓ 上传构建产物                         (30秒)     │   │
│  │                                                     │   │
│  │  总耗时: 约 8-10 分钟                              │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                 4. 服务器部署                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  sudo ./start-server.sh --github-release v1.0.0     │   │
│  │                                                     │   │
│  │  ✓ 从 GitHub 下载部署包                 (30秒)     │   │
│  │  ✓ 验证文件完整性                       (5秒)      │   │
│  │  ✓ 解压并复制文件                       (10秒)     │   │
│  │  ✓ 启动 Docker 容器                     (20秒)     │   │
│  │  ✓ 导入数据库（首次）                   (60秒)     │   │
│  │  ✓ 启动后端服务                         (30秒)     │   │
│  │  ✓ 启动前端服务                         (10秒)     │   │
│  │                                                     │   │
│  │  总耗时: 约 2-3 分钟                               │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                   5. 生产运行                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ✓ 管理后台: http://server/                        │   │
│  │  ✓ 后端 API: http://server:48081                   │   │
│  │  ✓ MySQL: localhost:3306                           │   │
│  │  ✓ Redis: localhost:6379                           │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 详细时间线

### 开发阶段（本地）

```
你的工作站
├── 修改代码 ........................... 你的开发时间
├── 本地测试 ........................... 根据需要
├── git commit ......................... 1秒
└── git push ........................... 5-10秒
```

### CI/CD 阶段（GitHub）

```
GitHub Actions Runner
├── [环境准备] ......................... 共 33秒
│   ├── Checkout 代码 ................. 5秒
│   ├── 设置 JDK 17 ................... 10秒
│   ├── 缓存 Maven .................... 15秒
│   └── 设置 Node.js & pnpm ........... 8秒
│
├── [后端构建] ......................... 共 4分钟
│   ├── 下载 Maven 依赖 ............... 30秒（缓存后）
│   ├── 编译 Java 代码 ................ 3分钟
│   └── 打包 JAR ...................... 30秒
│
├── [前端构建] ......................... 共 2分钟
│   ├── 安装 pnpm 依赖 ................ 15秒（缓存后）
│   ├── 编译 Vue3 代码 ................ 1分30秒
│   └── 打包 dist-prod ................ 15秒
│
└── [发布] ............................ 共 55秒
    ├── 准备部署包 ................... 15秒
    ├── 创建 tar.gz ................... 10秒
    ├── 生成 sha256 ................... 5秒
    ├── 创建 Release .................. 10秒
    └── 上传文件 ...................... 15秒

总计: 8-10分钟
```

### 部署阶段（服务器）

```
生产服务器
├── [下载] ............................ 共 35秒
│   ├── 获取 Release 信息 ............. 5秒
│   ├── 下载 tar.gz (50MB) ............ 25秒
│   └── 验证 sha256 ................... 5秒
│
├── [准备] ............................ 共 35秒
│   ├── 解压文件 ...................... 10秒
│   ├── 清理旧端口 .................... 5秒
│   └── 启动 Docker 容器 .............. 20秒
│
├── [数据库] .......................... 共 60秒（首次）
│   ├── 检查数据库 .................... 5秒
│   ├── 导入 SQL ...................... 50秒
│   └── 验证表 ........................ 5秒
│
└── [启动服务] ........................ 共 40秒
    ├── 启动后端 ...................... 30秒
    └── 启动前端 ...................... 10秒

总计: 2-3分钟（首次）
       1-2分钟（后续）
```

---

## 📊 关键组件

### 构建产物

```
yshop-deploy-v1.0.0.tar.gz
├── backend/
│   └── yshop-server-2.9.jar ......... 约 50MB
├── frontend/
│   └── dist-prod/ ................... 约 10MB
│       ├── index.html
│       ├── assets/
│       └── ...
├── VERSION .......................... 版本信息
└── README ........................... 部署说明

总大小: 约 60MB
压缩后: 约 40MB
```

### 服务端口

```
服务器端口分配
├── 3306  ............................ MySQL（Docker，内部）
├── 6379  ............................ Redis（Docker，内部）
├── 48081 ............................ 后端 API（对外）
└── 80    ............................ 前端 Web（对外）

外部访问:
├── http://server/            → 前端（80）
└── http://server:48081/      → 后端 API
```

### Docker 容器

```
Docker 容器
├── yshop-mysql
│   ├── 镜像: mysql:8.0
│   ├── 端口: 3306 → 127.0.0.1:3306
│   ├── 卷: ./mysql-data → /var/lib/mysql
│   └── 环境:
│       ├── MYSQL_ROOT_PASSWORD: root123456
│       └── MYSQL_DATABASE: yixiang-drink
│
└── yshop-redis
    ├── 镜像: redis:7.0
    ├── 端口: 6379 → 127.0.0.1:6379
    ├── 卷: ./redis-data → /data
    └── 命令: redis-server --requirepass redis123456
```

### 进程管理

```
系统进程
├── yshop-backend .................... PID 保存在 ~/logs/backend.pid
│   ├── 命令: java -jar yshop-server-*.jar
│   ├── 配置: --spring.profiles.active=local
│   ├── 日志: ~/logs/yshop-server.log
│   └── 端口: 48081
│
└── yshop-frontend ................... PID 保存在 ~/logs/frontend.pid
    ├── 命令: http-server dist-prod -p 80
    ├── 日志: ~/logs/yshop-frontend.log
    └── 端口: 80
```

---

## 🔄 更新流程

### 正常更新

```
开发 → 测试 → 发布 → 部署
  ↓      ↓      ↓      ↓
修改代码 本地测试 推送tag CI/CD构建
  ↓              ↓      ↓
提交PR   代码审查  合并   下载部署
  ↓              ↓      ↓
               创建tag  启动服务
                ↓
              等待8分钟
                ↓
            自动构建完成
                ↓
            服务器部署（2分钟）
                ↓
              完成！✅
```

### 快速热修复

```
发现 Bug → 修复 → 测试 → 紧急发布
    ↓        ↓      ↓        ↓
 生产环境   修改代码  快速验证  推送 tag
    ↓                ↓        ↓
  报警提醒         提交代码   v1.0.1-hotfix
    ↓                        ↓
  确认问题                 CI/CD 构建
    ↓                        ↓
  回滚到旧版              等待 8 分钟
    ↓                        ↓
  临时恢复              服务器快速部署
                             ↓
                       修复完成！✅
```

### 版本回滚

```
发现问题 → 决策 → 回滚
    ↓        ↓      ↓
  生产异常   确认回滚  执行回滚
    ↓        ↓      ↓
  查看日志   评估影响  sudo ./start-server.sh \
    ↓                  --github-release v0.9.9
  确定版本                ↓
    ↓                  下载旧版本（30秒）
  v1.0.0                  ↓
    ↓                  部署（1分钟）
  回滚到                  ↓
    ↓                  完成！✅
  v0.9.9
    ↓
  验证功能
    ↓
  正常！✅
```

---

## 📈 性能指标

### 首次部署

| 阶段 | 时间 | 说明 |
|------|------|------|
| 代码开发 | - | 你的开发时间 |
| Git Push | 10秒 | 推送到 GitHub |
| CI/CD 构建 | 10分钟 | GitHub Actions |
| 服务器准备 | 5分钟 | 安装 Docker、JDK |
| 服务器部署 | 3分钟 | 首次导入数据库 |
| **总计** | **约 20分钟** | 不含开发时间 |

### 后续更新

| 阶段 | 时间 | 优化 |
|------|------|------|
| Git Push | 10秒 | - |
| CI/CD 构建 | 6分钟 | 缓存优化 40% |
| 服务器部署 | 1.5分钟 | 无需导入数据 |
| **总计** | **约 8分钟** | 快了 60% |

### 紧急回滚

| 阶段 | 时间 | 说明 |
|------|------|------|
| 发现问题 | - | 监控告警 |
| 决策回滚 | 1分钟 | 评估影响 |
| 执行回滚 | 1.5分钟 | 下载+部署旧版 |
| 验证功能 | 2分钟 | 确认正常 |
| **总计** | **约 5分钟** | 快速恢复 |

---

## 🎯 各角色视角

### 开发者视角

```
我的日常工作流：
1. 写代码
2. 本地测试
3. git commit & push
4. 准备发布时打个 tag
5. 等 10 分钟喝杯咖啡
6. 通知运维部署
7. 下班！😊
```

### 运维视角

```
我的部署流程：
1. 收到部署通知
2. SSH 到服务器
3. cd yshop-drink
4. sudo ./start-server.sh --github-release v1.0.0
5. 等 2 分钟
6. 验证服务
7. 完成！🎉
```

### 用户视角

```
用户看到的：
1. 系统正常运行
2. （可能有 1-2 分钟维护）
3. 系统恢复，功能更新
4. 体验更好的功能 ✨
```

---

## 💡 最佳实践

### 发布策略

```
版本号规则: vX.Y.Z
├── X (主版本) ........ 重大变更，可能不兼容
├── Y (次版本) ........ 新功能，向后兼容
└── Z (补丁版本) ...... Bug 修复

示例:
├── v1.0.0 ............ 首次正式发布
├── v1.0.1 ............ Bug 修复
├── v1.1.0 ............ 新增功能
└── v2.0.0 ............ 重大更新
```

### 部署时机

```
推荐部署时间:
├── 正常更新 .......... 业务低峰期（凌晨2-4点）
├── 紧急修复 .......... 立即部署
└── 重大版本 .......... 周末或节假日

避免时间:
├── 业务高峰期 ........ 上午10-12点，下午3-5点
├── 周一早上 .......... 用户最活跃
└── 促销活动期间 ...... 等活动结束
```

### 监控检查

```
部署后必查:
├── 服务状态 .......... docker ps, lsof
├── 日志错误 .......... tail -f logs/yshop-server.log
├── 功能验证 .......... 登录、关键功能测试
├── 性能指标 .......... 响应时间、内存占用
└── 用户反馈 .......... 观察1小时

如有问题:
└── 立即回滚! ......... sudo ./start-server.sh --github-release v0.9.9
```

---

## 🎊 完整示例

### 场景：发布 v1.0.0

```bash
# === 本地开发机 ===
# 1. 完成开发
git add .
git commit -m "feat: 新增商品管理功能"
git push

# 2. 创建 tag
git tag v1.0.0 -m "Release: 商品管理功能上线"
git push origin v1.0.0

# 3. 监控构建（可选）
gh run watch
# 等待 8-10 分钟...

# === 生产服务器 ===
# 4. SSH 到服务器
ssh admin@prod-server

# 5. 停止旧服务
cd ~/yshop-drink
sudo ./stop-server.sh

# 6. 部署新版本
sudo ./start-server.sh --github-release v1.0.0
# 等待 1-2 分钟...

# 7. 验证
curl http://localhost:48081/admin-api/system/health
curl http://localhost/

# 8. 查看日志
tail -50 ~/logs/yshop-server.log

# 9. 完成！
echo "部署成功！v1.0.0 已上线 🎉"
```

---

## 📚 相关文档

- **[QUICK-START.md](QUICK-START.md)** - 3分钟快速开始 ⭐
- **[SERVER-DEPLOY.md](SERVER-DEPLOY.md)** - 完整部署指南 ⭐
- [.github/workflows/build-release.yml](.github/workflows/build-release.yml) - CI/CD 配置
- [start-server.sh](start-server.sh) - 启动脚本
- [stop-server.sh](stop-server.sh) - 停止脚本

---

**一切都是自动化的！** 🚀✨

**更新时间**: 2025-11-25  
**版本**: v1.0  
**状态**: ✅ 生产就绪

