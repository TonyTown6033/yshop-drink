# 快速修复清单 ✅

## 问题1：微信小程序登录失败

### 🎯 目标
修复错误码 40164 - IP地址不在白名单中

### ⚡ 操作步骤

1. **打开微信公众平台**
   - 网址：https://mp.weixin.qq.com/
   - 使用小程序账号登录

2. **找到IP白名单配置**
   ```
   开发 → 开发管理 → 开发设置 → IP白名单
   ```

3. **添加服务器IP**
   ```
   IP地址：124.160.210.182
   ```

4. **保存并等待**
   - 点击保存
   - 等待1-2分钟生效

5. **重新测试**
   - 在小程序中重新登录
   - 查看是否成功

### ✅ 验证成功标志
- 不再出现 "登录失败，请联系管理员"
- 能够成功获取到 openId
- 登录流程正常完成

---

## 问题2：短信验证码未收到

### 🎯 目标
修复钉钉短信发送失败（错误码 660026）

### ⚡ 方案A：修改钉钉机器人（推荐）

1. **打开钉钉**
   - 找到接收短信的钉钉群

2. **进入机器人设置**
   ```
   群设置 → 智能群助手 → 添加机器人 → 自定义（找到已有的）→ 设置
   ```

3. **修改安全设置**
   - 选择：自定义关键词
   - 添加关键词：`模拟短信`
   - 或添加：`验证码`

4. **保存配置**

5. **重新测试**
   - 在小程序中请求发送验证码
   - 检查钉钉群是否收到消息

### ⚡ 方案B：直接使用验证码（临时方案）

1. **打开终端**
   ```bash
   tail -50 /Users/town/logs/yshop-server.log | grep "您的验证码是"
   ```

2. **找到验证码**
   - 通常是：`9999`

3. **在小程序中使用**
   - 直接输入验证码：9999
   - 完成登录

### ✅ 验证成功标志
- 钉钉群收到短信通知消息
- 或能够使用日志中的验证码成功登录

---

## 🔍 实时日志监控

### 监控所有日志
```bash
tail -f /Users/town/logs/yshop-server.log
```

### 只看微信登录相关
```bash
tail -f /Users/town/logs/yshop-server.log | grep "auth-session\|40164"
```

### 只看短信相关
```bash
tail -f /Users/town/logs/yshop-server.log | grep "验证码\|sms\|SmsSend"
```

---

## 📋 完整测试流程

### 步骤1：准备工作
- [ ] 确认Docker容器运行中（MySQL、Redis）
- [ ] 确认后端服务运行中（端口48081）
- [ ] 打开终端监控日志

### 步骤2：修复微信登录
- [ ] 登录微信公众平台
- [ ] 添加IP白名单：124.160.210.182
- [ ] 保存配置

### 步骤3：修复短信功能
- [ ] 修改钉钉机器人安全设置
- [ ] 或者准备使用日志中的验证码

### 步骤4：测试验证
- [ ] 打开小程序
- [ ] 测试登录功能
- [ ] 测试短信验证码功能
- [ ] 检查日志确认无错误

---

## ⏱️ 预计修复时间

- **微信登录问题**：5分钟
- **短信验证码问题**：3分钟（方案A）或 1分钟（方案B）
- **总计**：约10分钟

---

## 🆘 如果还有问题

### 微信登录仍然失败
1. 检查IP白名单是否保存成功
2. 等待5分钟后重试
3. 检查小程序 AppID 是否正确
4. 查看日志确认具体错误

### 短信仍然收不到
1. 检查钉钉机器人设置是否保存
2. 尝试发送一条测试消息到群里
3. 使用方案B直接从日志获取验证码
4. 考虑配置真实短信渠道

---

## 📞 联系支持

如果以上方案都无法解决问题，请提供：

1. **微信登录相关**
   - IP白名单配置截图
   - 最新错误日志

2. **短信相关**
   - 钉钉机器人设置截图
   - 短信发送日志

3. **导出日志**
   ```bash
   tail -500 /Users/town/logs/yshop-server.log > ~/Desktop/error_log.txt
   ```

---

## 🎉 修复成功后

### 建议操作
1. 重启小程序，完整测试一遍
2. 记录修复过程，以备后用
3. 考虑生产环境的配置方案
4. 建立监控和告警机制

### 生产环境准备
- [ ] 申请真实短信服务（阿里云/腾讯云）
- [ ] 配置生产环境的短信渠道
- [ ] 设置服务器固定IP
- [ ] 配置域名和HTTPS证书
- [ ] 建立日志监控系统

