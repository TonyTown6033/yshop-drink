# 脚本更新日志

## 📅 2025-11-25 - 使用 nvm 管理 Node.js

### 🎯 更新内容

#### 1. start-server.sh 修改

**新增功能**：
- ✅ 自动检测和加载 nvm
- ✅ 优先使用 nvm 管理 Node.js
- ✅ 自动安装 nvm（如果未安装）
- ✅ 智能版本切换（版本过低时自动升级）
- ✅ 配置 nvm 国内镜像加速

**新增函数**：
```bash
load_nvm()        # 加载 nvm 环境
install_nvm()     # 安装 nvm
```

**修改函数**：
```bash
install_nodejs()      # 改用 nvm 安装 Node.js
check_environment()   # 添加 nvm 检测和加载逻辑
configure_mirrors()   # 添加 nvm 镜像配置
```

#### 2. 新增文件

**install-nvm.sh**
- 独立的 nvm 安装脚本
- 可单独运行安装 nvm + Node.js 18
- 自动配置国内镜像
- 安装 pnpm

**doc/nvm使用说明.md**
- 详细的 nvm 使用指南
- 常用命令参考
- 故障排查
- 最佳实践

---

## 🆚 修改对比

### 之前（直接安装 Node.js）

```bash
# 使用 apt 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt-get install -y nodejs

# 问题：
# - 需要 sudo 权限
# - 版本固定，难以切换
# - 全局包需要 sudo 安装
```

### 现在（使用 nvm）

```bash
# 安装 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 使用 nvm 安装 Node.js
nvm install 18
nvm use 18
nvm alias default 18

# 优势：
# - 无需 sudo 权限
# - 可管理多个版本
# - 快速切换版本
# - 更干净的系统环境
```

---

## 📋 工作流程

### 1. 检测 nvm

```bash
# 脚本启动时
1. 尝试加载 nvm 环境变量
2. 检查 nvm 命令是否可用
3. 显示 nvm 管理的版本信息
```

### 2. 版本检查

```bash
# 如果 Node.js 已安装
1. 检查版本是否 >= v16
2. 如果版本过低：
   - 有 nvm：使用 nvm 安装新版本
   - 无 nvm：安装 nvm 后安装新版本
```

### 3. 自动安装

```bash
# 如果 Node.js 未安装
1. 检查是否有 nvm
2. 没有 nvm：安装 nvm
3. 使用 nvm 安装 Node.js 18
4. 设置为默认版本
```

### 4. 镜像配置

```bash
# 配置三个镜像
1. nvm 镜像（下载 Node.js）
2. npm 镜像（下载包）
3. pnpm 镜像（下载包）
```

---

## 🚀 使用方法

### 场景1：全新环境

```bash
# 1. 先安装 nvm 和 Node.js（可选）
./install-nvm.sh

# 2. 重新加载 shell
source ~/.bashrc

# 3. 运行启动脚本
sudo ./start-server.sh
```

### 场景2：已有 nvm

```bash
# 直接运行启动脚本即可
sudo ./start-server.sh

# 脚本会自动：
# - 加载 nvm
# - 检测版本
# - 如需要，安装/切换版本
```

### 场景3：Node.js 版本过低

```bash
# 运行启动脚本
sudo ./start-server.sh

# 脚本会自动：
# - 检测到版本过低（如 v12）
# - 使用 nvm 安装 v18
# - 切换到新版本
# - 继续启动服务
```

---

## 🔧 技术细节

### 1. nvm 环境变量加载

```bash
# 支持多种安装位置
export NVM_DIR="${REAL_HOME}/.nvm"          # 标准位置
export NVM_DIR="/usr/local/opt/nvm"         # Homebrew 位置

# 加载 nvm
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
```

### 2. 以实际用户身份操作

```bash
# 获取实际用户（不是 root）
REAL_USER=${SUDO_USER:-$USER}
REAL_HOME=$(getent passwd "$REAL_USER" | cut -d: -f6)

# 所有 nvm/npm/pnpm 操作都使用实际用户
sudo -u ${REAL_USER} bash -c ". ${NVM_DIR}/nvm.sh && nvm install 18"
sudo -u ${REAL_USER} bash -c "npm install -g pnpm"
```

### 3. 国内镜像配置

```bash
# nvm 下载镜像
export NVM_NODEJS_ORG_MIRROR=https://npmmirror.com/mirrors/node
export NVM_IOJS_ORG_MIRROR=https://npmmirror.com/mirrors/iojs

# 写入配置文件
echo 'export NVM_NODEJS_ORG_MIRROR=https://npmmirror.com/mirrors/node' >> ~/.bashrc
```

### 4. 智能版本管理

```bash
# 检测当前版本
NODE_MAJOR_VERSION=$(node -v | sed 's/v//' | cut -d. -f1)

# 如果 < 16
if [ "$NODE_MAJOR_VERSION" -lt 16 ]; then
    # 有 nvm：直接安装新版本
    nvm install 18 && nvm use 18
    
    # 无 nvm：先安装 nvm
    install_nvm
    load_nvm
    nvm install 18
fi
```

---

## ✅ 测试清单

### 环境1：全新 Ubuntu（无 Node.js）

- [x] 自动安装 nvm
- [x] 自动安装 Node.js 18
- [x] 自动配置镜像
- [x] 自动安装 pnpm
- [x] 成功启动服务

### 环境2：已有 nvm + Node.js 18

- [x] 正确加载 nvm
- [x] 识别现有版本
- [x] 跳过安装
- [x] 成功启动服务

### 环境3：已有旧版本 Node.js（v12）

- [x] 检测到版本过低
- [x] 安装 nvm
- [x] 安装 Node.js 18
- [x] 切换到新版本
- [x] 成功启动服务

### 环境4：已有 nvm + Node.js 16

- [x] 正确加载 nvm
- [x] 识别版本满足要求
- [x] 直接使用
- [x] 成功启动服务

---

## 🎯 优势总结

### 之前的问题

- ❌ 需要系统级 sudo 安装
- ❌ 版本固定，无法灵活切换
- ❌ 全局包需要 sudo
- ❌ 与系统包管理器耦合
- ❌ 难以测试不同版本

### 现在的优势

- ✅ 用户级安装，无需 sudo
- ✅ 灵活管理多个版本
- ✅ 项目级版本隔离
- ✅ 快速切换和测试
- ✅ 更干净的系统环境
- ✅ 完全向下兼容

---

## 📞 常见问题

### Q1: 脚本会自动安装 nvm 吗？

**A**: 是的。如果检测到：
- Node.js 未安装，或
- Node.js 版本过低（< v16）

脚本会自动安装 nvm 并安装 Node.js 18。

### Q2: 我已经有系统 Node.js，会冲突吗？

**A**: 不会。nvm 管理的 Node.js 优先级更高，会覆盖系统版本。
建议卸载系统 Node.js：
```bash
sudo apt-get remove nodejs npm
```

### Q3: 如何手动切换 Node.js 版本？

**A**: 使用 nvm 命令：
```bash
nvm list              # 查看已安装版本
nvm install 20        # 安装新版本
nvm use 20            # 切换版本
nvm alias default 20  # 设为默认
```

### Q4: 为什么要重新加载 shell？

**A**: nvm 需要设置环境变量才能使用：
```bash
source ~/.bashrc
# 或重启终端
```

### Q5: 可以不用 nvm 吗？

**A**: 可以。如果你已经有合适版本的 Node.js（v16+），
脚本会直接使用，不会强制安装 nvm。

---

## 🔄 回滚方法

如果需要回到之前的方式（不使用 nvm）：

```bash
# 1. 卸载 nvm
rm -rf ~/.nvm

# 2. 从配置文件删除 nvm 相关行
vi ~/.bashrc  # 或 ~/.zshrc

# 3. 安装系统 Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 4. 安装 pnpm
sudo npm install -g pnpm
```

---

## 📚 相关文档

- [nvm 使用说明](./nvm使用说明.md)
- [服务器部署指南-Ubuntu](./服务器部署指南-Ubuntu.md)
- [快速修复清单](./快速修复清单.md)

---

**更新日期**: 2025-11-25  
**版本**: v2.0  
**作者**: AI Assistant

