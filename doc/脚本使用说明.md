# YSHOP 启动脚本使用说明

## 🚀 快速开始

### 使用 sudo 运行脚本

```bash
# 进入项目目录
cd /path/to/yshop-drink

# 使用 sudo 运行启动脚本
sudo ./start-server.sh
```

**重要**：脚本必须使用 `sudo` 运行！

---

## 📋 脚本功能

### ✅ 自动功能

1. **环境检查**
   - 检查 JDK 17
   - 检查 Maven
   - 检查 Node.js 和 pnpm
   - 检查 Docker

2. **镜像源配置**
   - Maven 阿里云镜像
   - npm/pnpm 淘宝镜像
   - Docker 阿里云镜像

3. **数据库自动导入**
   - 自动检测是否首次运行
   - 自动导入 SQL 文件：`yshop-drink-boot3/sql/yixiang-drink-open.sql`
   - 验证导入结果

4. **服务启动**
   - 启动 MySQL 和 Redis 容器
   - 编译并启动后端服务（端口 48081）
   - 启动管理界面前端（端口 80）

---

## 🔧 修改说明

### 主要变更

1. **使用 sudo 运行**
   - ✅ 不再将用户添加到 docker 组
   - ✅ 使用 sudo 执行脚本
   - ✅ 自动识别实际用户身份

2. **不重装 Docker**
   - ✅ 只配置 Docker 镜像加速
   - ✅ 如果 Docker 未安装，提示安装命令
   - ✅ 不会自动安装 Docker

3. **自动导入数据库**
   - ✅ 检测数据库是否为空
   - ✅ 自动导入 SQL 文件
   - ✅ 验证导入结果

---

## 📖 详细说明

### 为什么要用 sudo？

1. **Docker 命令需要权限**
   - 不将用户加入 docker 组更安全
   - 明确知道哪些操作需要 root 权限

2. **脚本会自动处理权限**
   - Docker 操作：使用 root 权限
   - Maven 编译：使用实际用户权限
   - 前端构建：使用实际用户权限
   - 日志文件：归属实际用户

### 脚本执行流程

```
sudo ./start-server.sh
  ↓
检查是否使用 sudo
  ↓
识别实际用户（SUDO_USER）
  ↓
设置日志目录（实际用户的home）
  ↓
检查环境（JDK, Maven, Node.js, Docker）
  ↓
配置镜像源
  - Docker 镜像（root 权限）
  - Maven/npm 镜像（实际用户权限）
  ↓
启动 Docker 容器
  - 检测是否首次运行
  - 自动导入数据库
  ↓
编译启动后端（实际用户权限）
  ↓
启动前端（实际用户权限）
  ↓
显示服务状态
```

---

## 🎯 使用示例

### 完整启动流程

```bash
# 1. 进入项目目录
cd /path/to/yshop-drink

# 2. 确保脚本有执行权限
chmod +x start-server.sh stop-server.sh

# 3. 使用 sudo 启动
sudo ./start-server.sh
```

### 首次运行

首次运行时，脚本会：
1. 检查并提示安装缺失的环境
2. 配置国内镜像源
3. 启动 MySQL 和 Redis 容器
4. **自动导入数据库**（约2-3分钟）
5. 编译后端（约5-10分钟）
6. 安装前端依赖（约3-5分钟）
7. 启动所有服务

**总耗时**：首次约 15-25 分钟

### 后续启动

后续运行时，脚本会：
1. 检查服务状态
2. 询问是否重启已运行的服务
3. 快速启动（约 2-3 分钟）

---

## 🔍 故障排查

### 权限错误

**错误**：`Permission denied`

**解决**：
```bash
# 确保使用 sudo
sudo ./start-server.sh
```

### Docker 未安装

**错误**：`未检测到 Docker`

**解决**：
```bash
# 使用阿里云镜像安装 Docker
curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun

# 或手动安装
sudo apt-get update
sudo apt-get install -y docker.io docker-compose-plugin

# 启动 Docker
sudo systemctl start docker
sudo systemctl enable docker
```

### 数据库导入失败

**错误**：`数据库导入失败`

**检查**：
```bash
# 查看导入日志
cat ~/logs/sql-import.log

# 手动导入
docker exec -i yshop-mysql mysql -uroot -proot123456 yixiang-drink < yshop-drink-boot3/sql/yixiang-drink-open.sql
```

### 端口被占用

**错误**：`Port already in use`

**解决**：
```bash
# 查看占用端口的进程
sudo lsof -i :48081  # 后端端口
sudo lsof -i :80     # 前端端口

# 停止进程
sudo pkill -f yshop-server  # 停止后端
sudo pkill -f vite          # 停止前端
```

---

## 📊 服务管理

### 停止服务

```bash
# 使用停止脚本
sudo ./stop-server.sh
```

### 查看日志

```bash
# 后端日志
tail -f ~/logs/yshop-server.log

# 前端日志
tail -f ~/logs/yshop-frontend.log

# Docker 日志
sudo docker logs -f yshop-mysql
sudo docker logs -f yshop-redis

# 数据库导入日志
cat ~/logs/sql-import.log
```

### 查看服务状态

```bash
# Docker 容器
sudo docker ps

# 后端进程
ps aux | grep yshop-server

# 前端进程
ps aux | grep vite

# 端口监听
sudo lsof -i :48081  # 后端
sudo lsof -i :80     # 前端
sudo lsof -i :3306   # MySQL
sudo lsof -i :6379   # Redis
```

---

## 🔧 高级配置

### 修改端口

#### 后端端口（默认 48081）

编辑：`yshop-drink-boot3/yshop-server/src/main/resources/application-local.yaml`

```yaml
server:
  port: 48081  # 修改为其他端口
```

#### 前端端口（默认 80）

编辑：`yshop-drink-vue3/vite.config.ts`

```typescript
server: {
  port: 80  // 修改为其他端口
}
```

### 修改数据库密码

1. 编辑 `docker-compose.yml`：
```yaml
services:
  mysql:
    environment:
      MYSQL_ROOT_PASSWORD: your_new_password
```

2. 编辑 `application-local.yaml`：
```yaml
spring:
  datasource:
    dynamic:
      datasource:
        master:
          password: your_new_password
```

3. 重启容器：
```bash
sudo docker compose down
sudo docker compose up -d
```

---

## 💡 常见问题

### Q1: 为什么要用 sudo？

A: 因为 Docker 命令需要 root 权限，使用 sudo 比将用户加入 docker 组更安全。

### Q2: 脚本会修改我的系统吗？

A: 脚本只会：
- 配置镜像源（Maven、npm、Docker）
- 不会安装任何软件（除非你同意）
- 所有操作都有日志记录

### Q3: 数据库会自动导入吗？

A: 是的，脚本会：
- 检测数据库是否为空
- 如果为空，自动导入 SQL 文件
- 验证导入结果

### Q4: 如何重新导入数据库？

A: 删除数据目录后重启：
```bash
sudo docker compose down
sudo rm -rf mysql-data
sudo ./start-server.sh
```

### Q5: 服务启动后如何访问？

A:
- 管理后台：http://服务器IP:80
- 后端 API：http://服务器IP:48081
- 默认账号：admin / admin123

---

## 📞 技术支持

- **官网**: https://www.yixiang.co/
- **QQ群**: 544263002
- **文档**: 项目 README.md

---

**修改日期**: 2025-11-25
**版本**: v2.0

