# 移动端登录问题说明

## 🔍 问题：用户不登录能否看到商品内容？

### 📊 当前情况分析

#### 前端配置

**文件：`yshop-drink-uniapp-vue3/api/goods.js`**

```javascript
// 商品列表接口
export function menuGoods(data) {
  return api.get('/product/products', data, { login: false })
  //                                           ↑
  //                                   明确标记不需要登录！
}
```

**文件：`yshop-drink-uniapp-vue3/api/market.js`**

```javascript
// 店铺列表接口
export function shopGetList(data) {
  return api.get('/store/list', data, { login: false })
}

// 广告列表接口
export function menuAds(data) {
  return api.get('/ad/list', data, { login: false })
}
```

✅ **这些接口都标记了 `{ login: false }`，说明设计上是不需要登录的！**

---

## ⚠️ 发现的问题

### 问题1：前端请求拦截器的Bug

**文件：`yshop-drink-uniapp-vue3/api/api.js`**

```javascript
const defaultOpt = { login: true }  // 默认需要登录

function baseRequest(options) {
  const token = cookie.get('accessToken')
  console.log('--> % token % token:\n', token)

  options.headers = {
    ...options.headers,
  }

  // ⚠️ 问题：这段判断被注释掉了！
  // if (options.login === true) {
  options.headers = {
    ...options.headers,
    Authorization: 'Bearer ' + token,  // 所有请求都会带上 token！
  }
  // }

  // 结构请求需要的参数
  const { url, params, data, login, ...option } = options
  // ...
}
```

**问题分析**：

1. ❌ `if (options.login === true)` 这个判断被注释掉了
2. ❌ 现在**所有请求都会带上 Authorization 头**
3. ❌ 即使接口设置了 `{ login: false }`，也会发送 token
4. ❌ 如果用户没有登录，token 是 `undefined` 或空值
5. ❌ 后端可能会返回 401 错误
6. ❌ 前端拦截器捕获 401，强制跳转到登录页

### 问题2：响应拦截器会拦截 401

```javascript
fly.interceptors.response.use(
  response => {
    return response
  },
  error => {
    // ⚠️ 问题：401 错误会被强制处理
    if (error.status == 401) {
      handleLoginFailure()  // 跳转到登录页
      return Promise.reject({ msg: '未登录', toLogin: true })
    }
    // ...
  }
)
```

---

## 🔧 解决方案

### 方案1：修复前端拦截器（推荐）

**修改文件：`yshop-drink-uniapp-vue3/api/api.js`**

```javascript
function baseRequest(options) {
  const token = cookie.get('accessToken')
  console.log('--> % token % token:\n', token)

  options.headers = {
    ...options.headers,
  }

  // ✅ 恢复这个判断
  if (options.login !== false) {  // 只有不是明确 false 时才添加 token
    options.headers = {
      ...options.headers,
      Authorization: 'Bearer ' + token,
    }
  }

  // 结构请求需要的参数
  const { url, params, data, login, ...option } = options

  // 发起请求
  return fly
    .request(url, params || data, {
      ...option,
    })
    .then(res => {
      const data = res.data || {}
      
      // #ifdef H5
      if (res.data.code == 1004004002) {
        if(isWeixin()){
          const url = cookie.get('index_url')
          console.log('redirect_uri:',url)
          location.href = url
          return
        }
      }
      // #endif
      
      if (res.status !== 200) {
        return Promise.reject({ msg: '请求失败', res, data })
      }

      // ⚠️ 修改：如果是不需要登录的接口，不要拦截 401
      if (data.code == 401 && options.login !== false) {
        uni.hideLoading()
        handleLoginFailure()
        uni.showToast({
          title: data.msg,
          icon: 'none',
          duration: 2000,
        })
        return Promise.reject({ msg: data.msg, res, data })
      }

      if (data.code != 0) {
        uni.showToast({
          title: data.msg,
          icon: 'none',
          duration: 2000,
        })
        return Promise.reject({ data, res })
      }

      return Promise.resolve(data.data, res)
    })
}
```

### 方案2：后端允许匿名访问

确保后端商品接口允许匿名访问（通常已经配置好了）。

---

## 📝 需要修改的具体代码

### 修改 api.js

**文件位置**：`yshop-drink-uniapp-vue3/api/api.js`

**第 60-65 行**，从：

```javascript
  // if (options.login === true) {
  options.headers = {
    ...options.headers,
    Authorization: 'Bearer ' + token,
  }
  // }
```

**改为**：

```javascript
  // 只有不是明确 false 时才添加 token
  if (options.login !== false) {
    options.headers = {
      ...options.headers,
      Authorization: 'Bearer ' + token,
    }
  }
```

**第 97-106 行**，从：

```javascript
  if (data.code == 401) {
    uni.hideLoading()
    handleLoginFailure()
    uni.showToast({
      title: data.msg,
      icon: 'none',
      duration: 2000,
    })
    return Promise.reject({ msg: data.msg, res, data })
  }
```

**改为**：

```javascript
  // 如果是不需要登录的接口，不要拦截 401
  if (data.code == 401 && options.login !== false) {
    uni.hideLoading()
    handleLoginFailure()
    uni.showToast({
      title: data.msg,
      icon: 'none',
      duration: 2000,
    })
    return Promise.reject({ msg: data.msg, res, data })
  }
```

---

## 🎯 修改后的效果

### 修改前

```
用户打开小程序
  ↓
首页加载商品列表
  ↓
请求带着空的 token：Authorization: Bearer undefined
  ↓
后端返回 401（如果需要认证）
  ↓
前端拦截器捕获 401
  ↓
❌ 强制跳转到登录页
```

### 修改后

```
用户打开小程序
  ↓
首页加载商品列表
  ↓
请求不带 Authorization 头（因为 login: false）
  ↓
后端允许匿名访问
  ↓
✅ 成功返回商品列表
  ↓
用户可以浏览商品
  ↓
需要下单时才提示登录
```

---

## 📋 哪些功能应该不需要登录？

### ✅ 应该允许匿名访问的接口

1. **商品相关**
   - ✅ 商品列表：`/product/products`
   - ✅ 商品详情：`/product/detail`
   - ✅ 商品分类：`/product/category`
   
2. **店铺相关**
   - ✅ 店铺列表：`/store/list`
   - ✅ 店铺详情：`/store/detail`
   
3. **广告/活动**
   - ✅ 广告列表：`/ad/list`
   - ✅ 活动信息

4. **其他**
   - ✅ 首页数据
   - ✅ 关于我们
   - ✅ 帮助中心

### ❌ 必须登录才能访问的接口

1. **用户相关**
   - ❌ 用户信息：`/user/info`
   - ❌ 修改资料
   
2. **订单相关**
   - ❌ 订单列表：`/order/list`
   - ❌ 创建订单：`/order/create`
   - ❌ 订单详情
   
3. **购物车**
   - ❌ 购物车列表
   - ❌ 添加购物车
   
4. **积分/优惠券**
   - ❌ 我的积分
   - ❌ 我的优惠券

---

## 🔍 如何验证修改是否生效

### 步骤1：修改代码

按照上面的说明修改 `api.js` 文件

### 步骤2：清除缓存

在微信开发者工具中：
- 点击"清缓存" → "清除全部缓存"
- 重新编译

### 步骤3：测试未登录状态

1. 清除登录状态
   ```javascript
   // 在控制台执行
   uni.clearStorage()
   ```

2. 重新打开小程序

3. 查看是否能看到商品列表

### 步骤4：查看网络请求

在微信开发者工具中：
- 打开"网络"标签
- 查看商品列表请求
- 检查 Request Headers

**修改前**：
```
Authorization: Bearer undefined
```

**修改后**：
```
（没有 Authorization 头）
```

### 步骤5：测试登录后的功能

1. 登录账号
2. 测试订单等需要登录的功能
3. 确认这些功能正常工作

---

## 💡 推荐的用户体验流程

### 理想的流程

```
用户打开小程序
  ↓
✅ 可以浏览商品、店铺（不需要登录）
  ↓
用户选择商品，点击"下单"
  ↓
检测到未登录
  ↓
提示用户登录
  ↓
登录成功
  ↓
继续下单流程
```

### 需要在页面中添加登录检查

**示例：订单确认页**

```javascript
// pages/order/order.vue
onLoad() {
  // 检查是否登录
  const token = cookie.get('accessToken')
  if (!token) {
    uni.showModal({
      title: '提示',
      content: '请先登录',
      success: (res) => {
        if (res.confirm) {
          uni.navigateTo({
            url: '/pages/components/pages/login/login'
          })
        } else {
          uni.navigateBack()
        }
      }
    })
    return
  }
  
  // 继续加载订单数据
  this.loadOrderData()
}
```

---

## 📞 总结

### 当前问题

1. ❌ 前端拦截器逻辑有 bug
2. ❌ 所有请求都带上 Authorization 头
3. ❌ 导致未登录用户无法浏览商品

### 解决方法

1. ✅ 修复 `api.js` 中的拦截器逻辑
2. ✅ 让 `{ login: false }` 的接口不带 Authorization 头
3. ✅ 让商品、店铺等接口可以匿名访问

### 预期效果

- ✅ 用户打开小程序就能浏览商品
- ✅ 不需要强制登录
- ✅ 需要登录的功能（下单、查看订单等）才提示登录
- ✅ 提升用户体验

---

## 🚀 立即可执行的操作

1. **修改 api.js 文件**
   - 位置：`yshop-drink-uniapp-vue3/api/api.js`
   - 修改第 60-65 行和第 97-106 行

2. **重新编译**
   - 清除缓存
   - 重新编译小程序

3. **测试**
   - 清除登录状态
   - 打开小程序
   - 查看是否能浏览商品

需要我帮你生成具体的修改代码吗？

