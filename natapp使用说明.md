# natapp 内网穿透使用说明

## 🔍 问题解答

### 为什么本地调试会出现公网IP（124.160.210.182）？

**答案**：您使用了 **natapp 内网穿透工具**！

## 📊 当前配置分析

### 从配置文件发现的信息

```yaml
配置文件：application-local.yaml
支付回调地址：http://yshop.natapp1.cc/admin-api/pay/notify/order
```

这表明：
- ✅ 使用了 natapp 内网穿透
- ✅ 域名：`yshop.natapp1.cc`
- ⚠️ 日志中记录的IP：`124.160.210.182`
- ⚠️ 当前解析到的IP：`198.18.2.23`

**重要发现**：IP地址已经变化！这证明了 natapp 免费版的IP不固定。

## 🔄 请求流程图

```
┌─────────────┐
│ 微信小程序   │
└──────┬──────┘
       │ 请求微信API (code2session)
       ↓
┌─────────────────────────────┐
│ 微信服务器                   │
│ (检测到来源IP: 124.160.210.182) │
│ ❌ IP不在白名单中，拒绝请求     │
└─────────────────────────────┘
       ↑
       │ 来源IP: 124.160.210.182
       │
┌──────┴──────────────────────┐
│ natapp 服务器                │
│ IP: 124.160.210.182         │
│ 域名: yshop.natapp1.cc      │
└──────┬──────────────────────┘
       │ 内网穿透
       ↓
┌──────────────────────────────┐
│ 本地开发机器                  │
│ 后端服务: localhost:48081     │
└──────────────────────────────┘
```

## 💡 为什么需要配置IP白名单

1. **小程序调用微信API的流程**：
   - 小程序获取 code → 发送到您的后端
   - 您的后端使用 code 调用微信接口 `jscode2session`
   - 微信接收到请求，检查来源IP

2. **微信看到的IP**：
   - 不是您的本地IP（127.0.0.1 或 192.168.x.x）
   - 而是 natapp 服务器的公网IP（124.160.210.182）
   - 因为请求是从 natapp 服务器发出的

3. **白名单机制**：
   - 微信为了安全，只允许白名单中的IP调用API
   - 必须把 natapp 的IP加入白名单

## 🛠️ 解决方案

### 方案1：添加当前 natapp IP 到白名单（临时）

**⚠️ 重要：先查询当前IP！**

```bash
# 查询当前 natapp 域名的IP
nslookup yshop.natapp1.cc
# 或
ping yshop.natapp1.cc
```

**当前检测结果**：
- 日志中的IP：`124.160.210.182`（可能已过期）
- 域名解析IP：`198.18.2.23`（当前IP）

**配置步骤**：
```
1. 登录微信公众平台：https://mp.weixin.qq.com/
2. 进入：开发 → 开发管理 → 开发设置 → IP白名单
3. 添加当前解析的IP（可能是 198.18.2.23）
4. 也可以同时添加 124.160.210.182（历史IP）
5. 保存
```

**优点**：
- ✅ 快速解决问题
- ✅ 可以立即继续开发

**缺点**：
- ❌ natapp 免费版IP可能会变化
- ❌ IP变化后需要重新配置
- ❌ 不稳定

### 方案2：使用 natapp 付费版（推荐）

natapp 付费版特点：
- ✅ 固定域名
- ✅ 固定IP
- ✅ 稳定可靠
- ✅ 配置一次，长期有效

官网：https://natapp.cn/

### 方案3：部署到云服务器（生产推荐）

```
选择云服务提供商：
- 阿里云：https://www.aliyun.com/
- 腾讯云：https://cloud.tencent.com/
- 华为云：https://www.huaweicloud.com/
```

**优点**：
- ✅ 固定公网IP
- ✅ 高稳定性
- ✅ 适合生产环境
- ✅ 配置一次，长期有效

**成本**：
- 入门级服务器：约 100-300元/月

### 方案4：使用自建 frp 服务器

如果您有云服务器，可以自建 frp：

```bash
# 在云服务器上安装 frp 服务端
# 本地运行 frp 客户端
# 完全控制，无限制
```

## 🔍 如何查看当前 natapp 配置

### 方法1：查看 natapp 日志

```bash
# 如果 natapp 在终端运行
# 日志会显示：
# - 分配的域名
# - 当前IP地址
# - 映射端口
```

### 方法2：查询域名解析

```bash
# 查看域名对应的IP
nslookup yshop.natapp1.cc

# 或者
ping yshop.natapp1.cc

# 或者
host yshop.natapp1.cc
```

### 方法3：访问 natapp 控制台

```
登录：https://natapp.cn/
查看：我的隧道 → 隧道详情
```

## ⚠️ 注意事项

### 1. natapp 免费版限制

- ❌ IP可能会变化
- ❌ 域名可能会变化
- ❌ 不保证稳定性
- ❌ 有流量限制

**建议**：
- 开发测试：可以使用免费版
- 生产环境：必须使用付费版或云服务器

### 2. IP 变化的处理

如果 natapp IP 变化了：

```bash
# 1. 查看新的IP
ping yshop.natapp1.cc

# 2. 更新微信白名单
# 登录微信公众平台 → 修改IP白名单

# 3. 重启服务测试
```

### 3. 多个 IP 配置

微信IP白名单支持配置多个IP：

```
可以添加：
- natapp 的IP（开发测试）
- 云服务器的IP（生产环境）
- 公司固定IP（如果有）
```

## 🎯 推荐配置方案

### 开发阶段（当前）

```
✓ 使用 natapp 免费版
✓ 添加 natapp IP 到微信白名单
✓ IP 变化时重新配置
```

### 测试阶段

```
✓ 升级 natapp 付费版
  或
✓ 部署到测试服务器
✓ 获得固定IP
```

### 生产阶段

```
✓ 部署到云服务器
✓ 使用固定公网IP
✓ 配置域名和SSL证书
✓ 建立监控和备份
```

## 📋 快速操作清单

### 立即要做的（解决当前问题）

- [ ] 登录微信公众平台
- [ ] 添加IP白名单：124.160.210.182
- [ ] 保存配置
- [ ] 等待1-2分钟
- [ ] 测试小程序登录

### 近期要做的（提升稳定性）

- [ ] 考虑升级 natapp 付费版
- [ ] 或准备云服务器
- [ ] 记录IP变化的处理流程
- [ ] 建立监控机制

### 长期要做的（生产准备）

- [ ] 申请云服务器
- [ ] 配置生产环境
- [ ] 申请域名和SSL证书
- [ ] 配置自动化部署
- [ ] 建立日志监控系统

## 🔗 相关资源

- natapp 官网：https://natapp.cn/
- natapp 文档：https://natapp.cn/article
- 微信开发文档：https://developers.weixin.qq.com/miniprogram/dev/
- 阿里云：https://www.aliyun.com/
- 腾讯云：https://cloud.tencent.com/

## ❓ 常见问题

### Q1: natapp IP 多久会变一次？

A: 免费版不保证IP稳定性，可能随时变化。付费版提供固定IP。

### Q2: 能不能不用内网穿透？

A: 微信小程序必须访问公网地址，本地开发必须使用内网穿透或部署到公网服务器。

### Q3: 配置白名单后还是报错怎么办？

A: 
1. 确认IP是否正确
2. 等待1-2分钟生效
3. 检查 natapp 是否运行正常
4. 查看后端日志确认错误信息

### Q4: 可以同时配置多个IP吗？

A: 可以！微信白名单支持配置多个IP地址，用换行符分隔。

### Q5: 测试环境和生产环境怎么配置？

A:
```
测试环境：使用 natapp + 配置 natapp IP
生产环境：使用云服务器 + 配置服务器固定IP
同时配置到白名单中即可
```

