name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # ä¾‹å¦‚: v2.9.0, v2.9.1
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    name: Build Release Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Configure Maven mirror (China)
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 
                    http://maven.apache.org/xsd/settings-1.0.0.xsd">
              <mirrors>
                  <mirror>
                      <id>aliyunmaven</id>
                      <mirrorOf>*</mirrorOf>
                      <name>é˜¿é‡Œäº‘å…¬å…±ä»“åº“</name>
                      <url>https://maven.aliyun.com/repository/public</url>
                  </mirror>
              </mirrors>
          </settings>
          EOF
      
      - name: Build Backend
        run: |
          cd yshop-drink-boot3
          mvn clean package -DskipTests -T 1C
          
          # éªŒè¯ jar æ–‡ä»¶æ˜¯å¦ç”Ÿæˆï¼ˆä½¿ç”¨ compgen æˆ– findï¼‰
          JAR_COUNT=$(find yshop-server/target -name "yshop-server*.jar" -type f 2>/dev/null | wc -l)
          
          if [ "$JAR_COUNT" -eq 0 ]; then
            echo "Error: JAR file not found after build"
            echo "Listing target directory:"
            ls -la yshop-server/target/ || echo "Target directory not found"
            exit 1
          fi
          
          echo "Backend build successful"
          echo "Found $JAR_COUNT jar file(s):"
          find yshop-server/target -name "yshop-server*.jar" -type f -exec ls -lh {} \;
      
      - name: Build Frontend
        run: |
          cd yshop-drink-vue3
          pnpm config set registry https://registry.npmmirror.com
          pnpm install --no-frozen-lockfile
          pnpm run build:prod
        env:
          DISABLE_ESLINT: 'true'  # ç¦ç”¨ ESLint æ£€æŸ¥
      
      - name: Prepare Deploy Package
        run: |
          mkdir -p deploy/backend
          mkdir -p deploy/frontend
          
          # å¤åˆ¶åç«¯ jar
          cp yshop-drink-boot3/yshop-server/target/yshop-server*.jar deploy/backend/
          
          # å¤åˆ¶å‰ç«¯ dist-prod
          cp -r yshop-drink-vue3/dist-prod deploy/frontend/
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
          echo "Version: ${GITHUB_REF_NAME}" > deploy/VERSION
          echo "Build Date: $(date '+%Y-%m-%d %H:%M:%S')" >> deploy/VERSION
          echo "Commit: ${GITHUB_SHA}" >> deploy/VERSION
          
          # åˆ›å»ºéƒ¨ç½²è¯´æ˜
          cat > deploy/README.md << 'EOFREADME'
          # YSHOP éƒ¨ç½²åŒ…
          
          ## ç‰ˆæœ¬ä¿¡æ¯
          
          è¯·æŸ¥çœ‹ VERSION æ–‡ä»¶
          
          ## å¿«é€Ÿéƒ¨ç½²
          
          ```bash
          # 1. è§£å‹åˆ°é¡¹ç›®ç›®å½•
          tar -xzf yshop-deploy.tar.gz -C /path/to/yshop-drink/
          
          # 2. å¯åŠ¨æœåŠ¡
          cd /path/to/yshop-drink
          sudo ./start-server.sh --github-release
          ```
          
          ## æ–‡ä»¶è¯´æ˜
          
          - `backend/yshop-server-*.jar` - åç«¯æœåŠ¡
          - `frontend/dist-prod/` - å‰ç«¯æ„å»ºäº§ç‰©
          - `VERSION` - ç‰ˆæœ¬ä¿¡æ¯
          EOFREADME
      
      - name: Create Release Package
        run: |
          cd deploy
          tar -czf ../yshop-deploy-${GITHUB_REF_NAME}.tar.gz backend frontend VERSION README.md
          cd ..
          
          # åˆ›å»º checksums
          sha256sum yshop-deploy-${GITHUB_REF_NAME}.tar.gz > yshop-deploy-${GITHUB_REF_NAME}.tar.gz.sha256
      
      - name: Get Release Info
        id: release_info
        run: |
          echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          echo "date=$(date '+%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            yshop-deploy-${{ steps.release_info.outputs.version }}.tar.gz
            yshop-deploy-${{ steps.release_info.outputs.version }}.tar.gz.sha256
          body: |
            ## YSHOP æ„è±¡ç‚¹é¤ç³»ç»Ÿ ${{ steps.release_info.outputs.version }}
            
            ### ğŸ“¦ å‘å¸ƒå†…å®¹
            
            - åç«¯æœåŠ¡ (Spring Boot 3)
            - å‰ç«¯ç®¡ç†ç•Œé¢ (Vue3)
            
            ### ğŸš€ å¿«é€Ÿéƒ¨ç½²
            
            ```bash
            # æ–¹æ³•1ï¼šè‡ªåŠ¨ä¸‹è½½å¹¶éƒ¨ç½²
            cd /path/to/yshop-drink
            sudo ./start-server.sh --github-release ${{ steps.release_info.outputs.version }}
            
            # æ–¹æ³•2ï¼šæ‰‹åŠ¨ä¸‹è½½
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.release_info.outputs.version }}/yshop-deploy-${{ steps.release_info.outputs.version }}.tar.gz
            tar -xzf yshop-deploy-${{ steps.release_info.outputs.version }}.tar.gz -C /path/to/yshop-drink/
            cd /path/to/yshop-drink
            sudo ./start-server.sh --skip-build --prod-frontend
            ```
            
            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            
            - Ubuntu 20.04+
            - JDK 17
            - Docker & Docker Compose
            - 2æ ¸4G å†…å­˜ä»¥ä¸Š
            
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            
            è¯·æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md)
            
            ### ğŸ”’ æ–‡ä»¶æ ¡éªŒ
            
            ```bash
            sha256sum -c yshop-deploy-${{ steps.release_info.outputs.version }}.tar.gz.sha256
            ```
            
            ---
            
            **å‘å¸ƒæ—¶é—´**: ${{ steps.release_info.outputs.date }}  
            **æ„å»ºæäº¤**: ${{ github.sha }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yshop-deploy-${{ steps.release_info.outputs.version }}
          path: |
            deploy/
          retention-days: 30

